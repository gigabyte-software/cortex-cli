name: Deploy Cortex Coder

on:
  release:
    types: [published]

jobs:
  trigger-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Cortex Coder Deployment
        env:
          DEPLOY_URL: ${{ secrets.FORGE_DEPLOY_TRIGGER_URL }}
        run: |
          if [ -z "$DEPLOY_URL" ]; then
            echo "‚ùå Error: FORGE_DEPLOY_TRIGGER_URL secret is not set"
            exit 1
          fi
          
          echo "üöÄ Triggering Cortex Coder deployment..."
          echo "URL: ${DEPLOY_URL:0:30}..." # Show first 30 chars for debugging
          
          response=$(curl -X POST \
            -w "\nHTTP_STATUS:%{http_code}" \
            -f \
            -s \
            --max-time 30 \
            "$DEPLOY_URL" 2>&1) || exit_code=$?
          
          if [ ${exit_code:-0} -ne 0 ]; then
            echo "‚ùå Deployment trigger failed with exit code: $exit_code"
            echo "Response: $response"
            exit 1
          fi
          
          echo "‚úÖ Deployment triggered successfully"
          echo "Response: $response"